<!DOCTYPE html>
<html>
  <head>
    <title>Geocoding Service</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="./style.css" />
  </head>
  <body>
    <div id="floating-panel">
      <input id="address" type="textbox" value="Иркутск" />
      <input id="submit" type="button" value="Geocode" />
    </div>
    <div id="map"></div>
    <!-- <script src="./app.js"></script> -->
    <script>
      const mockMarkers = [
        {coords: { lat: 53.59778, lng: 103.29639 }}
      ];

      const GMAK = `AIzaSyDN2t-jztEv0j2u-Ep3Zw9B8y0hneXCl6s`;

      const GOOGLE_MAP1 = `https://maps.googleapis.com/maps/api/js?key=${GMAK}&callback=initMap`;
      const GOOGLE_MAP2 = `https://maps.googleapis.com/maps/api/js?key=${GMAK}`;

      // Подключаемся к maps.googleapis.com
      const init = () => {
        const script = document.createElement('script');
        script.src = GOOGLE_MAP1;
        document.getElementsByTagName('head')[0].appendChild(script);
      };

      function initMap() {
        // Убираем overflow который подставляет Tilda
        setTimeout(() => {
          const hidden = document.querySelector(`#map`);
          if (hidden) {
            hidden.style.overflow = null;
            hidden.style.position = null;
          }
        }, 1000);
        
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 7,
          center: { lat: 52.29778, lng: 104.29639 },
          // mapTypeId: 'terrain'
        });
        const geocoder = new google.maps.Geocoder();

        document.getElementById("submit").addEventListener("click", function() {
          geocodeAddress(geocoder, map);
        });

        // Выводим тестовый маркер
        const latLng = new google.maps.LatLng(mockMarkers[0].coords.lat,mockMarkers[0].coords.lng);
        const marker = new google.maps.Marker({
          map: map,
          position: latLng
        });
      };


      function geocodeAddress(geocoder, resultsMap) {
        const address = document.getElementById("address").value;
        geocoder.geocode({ address: address }, function(results, status) {
          if (status === "OK") {
            resultsMap.setCenter(results[0].geometry.location);
            const marker = new google.maps.Marker({
              map: resultsMap,
              position: results[0].geometry.location
            });
          } else {
            alert("Geocode was not successful for the following reason: " + status);
          }
        });
      };

      // SATBEAMS

      const satUrl = `http://maps.satbeams.com/!ajax/displaymap?hsize=570&vsize=400&norad=27528&beam=3&lat=38&lng=0&marker_lat=38&marker_lng=0&zoom=2&minEIRP=42&levels=2&infowindow=1&direction=1&limits=1&marker=1&mapstyle=2&GMAK=${GMAK}`;

      const getFromSatBeamsData = (url) => {
        console.log(`Старт запроса`);
        return fetch(url)
          .then(response => {
            console.log('response: ', response);
            response.json()
            console.log('response.json(): ', response.json());
          })
          .then(res => {
            console.log('res: ', res);
            return res
          })
          .catch((err) => {
            console.log('err: ', err);
          })
      };

      init();
      getFromSatBeamsData(satUrl);
  
  
    </script>


  </body>
</html>